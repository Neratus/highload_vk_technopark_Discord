# Выполнение задания по предмету "Высоконагруженные системы" : Курсовая работа "Разработка сервиса Discord"

## Тема и целевая аудитория

### Распределение целевой аудитории ([источник_2]) ([источник_3])

- Половое распределение:
    - Мужчины: 67%
    - Женщины: 33%
- Возрастное распределение:
    - от 16 до 24: 20%
    - от 25 до 34: 53%
- Географическое распределение:
    - США: 27%
    - Бразилия: 12.8%
    - Россия: 4.4%
    - Индия: 4.24 %
    - Великобритания: 3.85%


### Фунционал


#### Основной MVP функционал
- Сервис авторизации:
    - Регистрация 
    - Вход в аккаунт
    - Выход из аккаунта
- Профили пользователя:
    - Изменение профиля
    - Добавление аватарки
    - Изменение аватарки профиля
- Группы:
    - Создание группы
    - Удаление группы
    - Добавление в группу участника
    - Исключение из группы участника
    - Изменение параметров группы
    - Добавление пользователя в админы группы
- Чаты
    - Присоединиться к чату
    - Выйти из чата
    - Написать сообщение
    - Изменить сообщение
    - Удалить сообщение
    - Отправка медиа в чат
- Аудио чаты
    - Создать аудиочата
    - Удалить аудиочата
    - Присоединиться к аудиочату
    - Выйти из аудиочата
    - Включение/выключение микрофона
- Сообщества
    - Создание сообщества
    - Удаление сообщества
    - Добавление в сообщество участника
    - Исключение из сообщества участника
    - Изменение параметров сообщества
    - Добавление пользователя в админы сообщества
    - Добавление тематики сообщества
    - Удаление тематики сообщества

### Отличие от конкурентов ([источник_5]):

Discord создаются полноценные серверы, которые служат аналогом больших чатов по интересам или рабочим пространствам. Сервер можно структурировать с помощью категорий и каналов — текстовых, голосовых и видео. Это позволяет разделять общение по темам и типам активности: обсуждения, созвоны, демонстрация экрана, неформальное общение.

Ключевую роль играет система ролей и прав доступа. На каждом сервере администраторы назначают роли (например, участник, модератор, админ, гость), и от этого зависят возможности пользователей: доступ к каналам, право писать сообщения, подключаться к аудио, включать видео, управлять другими пользователями. Грамотная настройка ролей делает общение удобным и упорядоченным, а также снижает нагрузку на модераторов.



### Конкурентные площадки ([источник_1])
- Steam Chat
- Teamspeak ([источник_4])
- Mumble



### Продуктовые метрики (2023 г.) ([источник_3])

| Название метрик                               | Значение |
| :-------------------------------------------- | :------- |
| MAU (mm)                                      | 154      |
| DAU (mm)                                      | 26.5     |
| Активные сервера(mm)                          | 6.7      |
| Количество зарегистированных польззователей   | 563      |
| Ограничение на объем файла     ([источник_5]) | 25 МБ    |

## Расчет нагрузки


### Технические метрики  

**Сообщения** – 850 млн/день ([источник_7])  

**Предположительный размер сообщения** – ~1 КБ (ограничение 2000 символов в 1 сообщении, [источник_5])  


> **Формула:**  
> `Сообщения в день × Размер сообщения`  
>   
> **Расчёт:**  
> `850e6 × 1 КБ = ~0.85e9 КБ ≈ 810 ГБ ≈ ~0.8 ТБ в сутки`  
> `≈ 310 ТБ в год`  


Также делаем предположение, что 5% из них - является медиа сообщениями
На каждое сообщение накладывается лимит 25МБ, предполагаем худший случай, что каждое сообшение - ровно 25Мб тогда


> **Формула:**  
>   
> **Расчёт:**  
> `850e6 × 0.05 × 25 МБ = 1.0625e9 МБ ≈ 1.06e6 ГБ ≈ 1062.5 ТБ ≈ ~1.06 ПБ в сутки`  
> `≈ 387 ПБ в год`  
---



**Голосовые чаты** – 4 млрд минут голосового общения ([источник_6])  

| Кодек / Качество     | Битрейт (Кбит/с) | Битрейт (КБ/с) | Размер аудио в минуту | Расчётный объём за сутки (4 млрд минут) |
|-----------------------|------------------|----------------|------------------------|------------------------------------------|
| Opus (стандартное)   | 64               | 8              | ~480 КБ                | ~1.92 ПБ                                 |
| Opus (высокое)       | 96               | 12             | ~720 КБ                | ~2.88 ПБ                                 |
| Opus (экономное)     | 32               | 4              | ~240 КБ                | ~0.96 ПБ                                 |
| Телефонное (G.711)   | 64               | 8              | ~480 КБ                | ~1.92 ПБ                                 |


**Предположительный битрейт для приложения - стандартное качество OPUS**, то есть битрейт – 8 КБ/с, дневной объем хранилища - 1.92 Пб 



---


### Расчет хранилища пользователя 

**Допущения для раcчета**: 

Допущения для расчёта:

- Аватарка: лимит 25 МБ, средний размер — 1 МБ, в расчётах на пользователя учтём 0.5 МБ (среднее распределение, часть пользователей без аватарок).
- Метаданные аккаунта: 1 МБ (никнейм, email, хэши паролей, настройки, список друзей, список серверов).
- Сообщения: всего пользователи отправляют 850 млн/день → ~0.8 ТБ/день.
- Метаданные чата (серверы, каналы): 20% от объёма сообщений.
- Аудиочаты: хранение не требуется.
- Медиафайлы: 5% сообщений содержат вложения, средний размер вложения ~25 МБ.

Также необходимо учитывать средний прирост аудитории -  9.4% ([источник_15])


| Тип данных               | Размер на 1 юзера | Кол-во юзеров       | Суточный объём   | Годовой объём (без роста) | Годовой объём (с ростом 9.4%) |
| ------------------------ | ----------------: | -----------------: | ---------------: | ------------------------: | ----------------------------: |
| **Профили (аватарки)**   |            0.5 МБ |       563 млн       |               - |                ~268.5 ТБ  |                             - |
| **Профили (метаданные)** |              1 МБ |       563 млн       |               - |                  ~536.9 ТБ |                             - |
| **Текстовые сообщения**  |                 - |  26.5 млн DAU      |       ~0.8 ТБ    |                  ~288.9 ТБ |                    ~315.3 ТБ |
| **Метаданные чатов**     |                 - |                   - |       ~0.16 ТБ   |                   ~57.8 ТБ |                     ~63.2 ТБ |
| **Медиафайлы**           |                 - |  26.5 млн DAU      |     ~1062.5 ТБ   |               ~361.2 ПБ    |                     ~395.2 ПБ |
| **ИТОГО**                |                   |                     |   ~1.06 ПБ/день  |               ~362.3 ПБ    |                     ~396.4 ПБ |



### RPS (requests per second)

**Допущения для раcчета**: 

Для расчета пиковой нагрузки необходим пиковый коэффицент. Так как специфика дискорда заключается в том, что он в первую очередь предназначен для коммуникации игороков, поэтому основной всплеск приходится на вечер будней(19:00-2:00). В остальное время предполагается, что пользователи и ли работают в будни, или их активность равномерно распределена(выходные). Также отдельные пики будут приходиться на релизы крупных игр(например silksong), а также учитывать то, что во многом активность неплавная и сопровождается частыми перепадами. В этом можно убедиться взяв для анализа график активности Steam ([источник_14]). По сравнению с утром, вечерний трафик может увеличиваться в 1.5-2 раза. Также можно сравнить Discord с сервисом Netflix из-за схожести времени спада/падений,а также особенности потоковой передачи ([источник_15]). У Netflix - примерный пиковый коэффицент - 3.0. Поэтому можно предполагать аналогичный 

 Считаем, что коэффицент пика равен 3.0, средний пиковый коэффицент обычно считается как 2.5, однако тут нужно учитывать специфику Discord. Приложение предназначено для коммуникации игроков,  ([источник_8])  


Расчет среднего RPS: (Событий в день) / (24 часа * 3600 секунд).
Расчет пикового RPS: Средний RPS * Пиковый коэффициент (3.0).

### Расчет трафика

| Категория (MVP)              | Сценарии (MVP-группировка)                                                                                                       | Событий в день | На пользователя | Средний RPS | Пиковый RPS | Размер данных | Средний трафик (Гбит/с) | Пиковый трафик (Гбит/с) | Суточный объём |
| ---------------------------- | -------------------------------------------------------------------------------------------------------------------------------- | -------------: | --------------: | ----------: | ----------: | ------------: | ----------------------: | ----------------------: | -------------: |
| **Авторизация**              | Регистрация, Вход в аккаунт, Выход из аккаунта                                                                                   |          53.0M |             2.0 |         614 |       1 842 |          1 КБ |                   0.005 |                   0.015 |        \~53 ГБ |
| **Профиль пользователя**     | Изменение профиля, Добавление/изменение аватарки                                                                                 |          26.5M |             1.0 |         307 |         921 |          5 КБ |                   0.012 |                   0.036 |       \~132 ГБ |
| **Группы (метаданные)**      | Создание/удаление группы, Добавление/исключение участника, Изменение параметров, Добавление админов                              |          26.5M |             1.0 |         307 |         921 |          2 КБ |                   0.005 |                   0.015 |        \~53 ГБ |
| **Сообщества (метаданные)**  | Создание/удаление сообщества, Добавление/исключение участника, Изменение параметров, Добавление админов, Добавление/удаление тем |          26.5M |             1.0 |         307 |         921 |          2 КБ |                   0.005 |                   0.015 |        \~53 ГБ |
| **Чаты (текстовые)**         | Присоединение/выход, Написать сообщение, Изменить сообщение, Удалить сообщение                                                   |         807.5M |            30.5 |       9 346 |      28 038 |          1 КБ |                   0.075 |                   0.224 |     \~807.5 ГБ |
| **Запросы ленты сообщений**  | Получение истории чатов, обновление списка сообщений (читающая нагрузка)                                                         |         2 650M |           100.0 |      30 671 |      92 013 |         50 КБ |                  122.68 |                  368.04 |     \~132.5 ТБ |
| **Загрузка медиафайлов**     | Отправка медиа в чат                                                                                                             |          42.5M |             1.6 |         492 |       1 476 |         25 МБ |                    98.4 |                   295.2 |    \~1062.5 ТБ |
| **Аудио-чаты (метаданные)**  | Создание/удаление аудиочата, Присоединение/выход, Вкл/выкл микрофона                                                             |         106.0M |             4.0 |       1 227 |       3 681 |          2 КБ |                   0.020 |                   0.059 |       \~212 ГБ |
| **Голосовая связь (трафик)** | Потоковая передача аудио (Opus 64 кбит/с, стандартное качество)                                                                  |     4 000M мин |         151 мин |         210 |         630 |     64 Кбит/с |                   177.8 |                   533.3 |      \~1.92 ПБ |


## Глобальная балансировка нагрузки

### Распределение пользователей

Рассмотрим примерное распределение трафика по странам ([источник_9], [источник_10]):

![alt text](users.png)
![alt text](other.png)

Видно, что основная концентрация пользователей приходит на:
- **США** (25-30% трафика)
- **Канаду** (2-3%)
- **Европейские страны**

Для получения приближенной картины ([источник_11]):

![alt text](internet.png)

Можно видеть, что основное количество пользователей располагается на восточном побережье США и в центральной Европе (Германия, Франция, Великобритания).

Учитывая основное местоположение магистральных кабелей ([Submarine Cable Map]) и точек обмена интернет-трафиком ([IXP]), оптимальным является размещение дата-центров (ДЦ) в узлах с наилучшей связностью. Это позволит минимизировать задержку (latency) для ключевых регионов аудитории.Из этого следует, что оптимальнее разместить ДЦ в следующих локациях:


**Северная Америка** (25–30% трафика):
- **Нью-Йорк** — восточное побережье, доступ к AMS/Лондону через трансатлантические кабели
- **Сан-Франциско** — западное побережье, маршруты в Азию
- **Майами** — маршруты к Латинской Америке

**Европа:**
- **Амстердам** (AMS-IX — крупнейший IX Европы)
- **Лондон** (высокая связанность, хаб трансатлантических линий)
- **Франкфурт** (DE-CIX, центральная точка европейского трафика)

**Азия:**
- **Сингапур** (юго-восточная Азия)
- **Токио** (восточная Азия)
- **Мумбаи** (южная Азия)

**Южная Америка:**
- **Сан-Паулу**
- **Рио-де-Жанейро**

### Схемы балансировки

#### **DNS балансировка**

В связи с отдельными требованиями скорости и низкой задержки для домена аудиочатов, стоит использовать **latency-based DNS**. Этот алгоритм обеспечивает распределение среди сервисов бэкенда на разные сервера, не жертвуя при этом скоростью. Благодаря latency-based DNS мы сможем сократить задержку при передаче аудиопакетов и при этом, в отличие от GeoDNS, который ориентируется на географическое положение IP, latency-DNS обеспечивает более точный выбор при использовании VPN или провайдеров с нетипичной маршрутизацией.

#### **Anycast балансировка**

Для домена аудиочатов и других сервисов, для которых критична задержка, рекомендуется использовать **Anycast** ([источник_19]) . В этом подходе один публичный IP объявляется сразу из нескольких дата-центров через BGP. Пользовательский трафик автоматически маршрутизируется в ближайший ДЦ, что снижает задержки и повышает отказоустойчивость.

#### **Разделение применения DNS и Anycast**

Приоритетная задача при выборе методов балансировки - обеспечить как можно меньшую задержку для аудиочатов, которые являются главным доменом приложения. При DNS lookup IP адрес сервера потом кешируется на стороне клиента/сервера провайдера, лучше использовать комбинацию DNS и Anycast для выбора ближайшего сервера.

**Алгоритм работы:**

1. **Latency-DNS определяет ближайший регион** для пользователя (например, eu-west, us-east)
2. **DNS возвращает IP регионального балансировщика**
3. **Anycast используется внутри региона** или континента — один и тот же IP анонсируется из нескольких PoP внутри региона, и пакеты доставляются в ближайший узел

**Полная схема:**
- Клиент выполняет DNS-запрос → получает IP ближайшего региона
- Устанавливает соединение с Anycast-IP внутри региона → попадает в локальный PoP
- PoP перенаправляет трафик на ближайший ДЦ
- При сбое PoP BGP автоматически перенаправляет трафик в соседний ДЦ
- Если регион недоступен — DNS health check исключает его из ответов

Таким образом, **DNS управляет выбором региона**, а **Anycast — доставкой пакетов внутри него**. Это снижает влияние DNS-кеширования и обеспечивает минимальное время реакции при сбоях.

### Механизм регулировки трафика между ДЦ

**Для различных типов трафика:**

- **Текстовые сообщения и медиафайлы** — применяется асинхронная репликация данных между ДЦ, преимущественно по географическому принципу:
  - США → первичный ДЦ США, резервный — Европа
  - Европа → первичный ДЦ Европа, резервный — США

- **Аудиочаты** — трафик обрабатывается строго локально в пределах одного ДЦ. Голосовые пакеты маршрутизируются внутри кластера, чтобы минимизировать задержку и избежать межрегиональных хопов.

**В случае перегрузки или сбоя одного ДЦ:**

- Часть трафика автоматически перераспределяется на резервные ДЦ с помощью DNS или Anycast
- Балансировка происходит с учётом метрик latency, RPS и нагрузки ресурсов
- Используется мониторинг состояния ДЦ и автоматическое обновление записей DNS
- При восстановлении региона трафик возвращается обратно постепенно, чтобы избежать пиковых нагрузок


## Локальная балансировка нагрузки


### Функциональное разбиение по доменам


В случае Discord, согласно [MVP](#основной-mvp-функционал),  выделить 3 основных домена: 
1) Домен авторизации
    Основные функции: регистрация, вход/выход из аккаунта, хранение учётных данных и настроек пользователей.
    Для него требуется особая отказоустойчивоть и обеспечение сохранности данных пользователей. На него не будет накладываться особая нагрузка, в связи с тем, что авторизация/регистрация выполняются довольно редко(максимум 1-2 раза в день на 1 пользователя, пользователи необязательно будут выходить из аккаунтов)

2) Домен сообщений 
    Основные функции: отправка, редактирование, удаление текстовых сообщений, хранение медиафайлов, метаданных чатов и пользователей.
    Обращение к этому домену уже идет чаще и скорость, несмотря на то, что является некритичной по сравнению с аудиочатом, преобретает более важный статус
3) Домен аудиочатов
    Основные функции: потоковое аудио, управление микрофоном, подключение/отключение участников, управление голосовыми каналами. 
    Самый важный домен, для него как скорость соединения так и потеря пакетов может быть критична, рекомендуется поместить внутри каждого ДЦ.  

Также мы предполагаем, что ввиду продуктовых требований, каждые запросы в пределах одного домена будут обрабатываться одинаково по времени, все запросы имеют одинаковый приоритет и размер. 

### Сравнение методов локальной балансировки

| Уровень       | Методы балансировки                           | Плюсы                                                                 | Минусы                                                                 | Использование в Discord                              |
|---------------|-----------------------------------------------|----------------------------------------------------------------------|------------------------------------------------------------------------|------------------------------------------------------|
| DNS-уровень   | - Geo-based<br>- Round Robin<br>- Weighted RR | - Простота<br>- Глобальная балансировка<br>- Высокая доступность      | - Долгий TTL<br>- Нет проверки здоровья<br>- Нет учёта реальной нагрузки | Первоначальная маршрутизация по регионам             |
| L4 (Transport)| - Round Robin<br>- Least Connections<br>- Source IP Hash | - Высокая производительность<br>- Низкая задержка<br>- Простота       | - Не видит содержимое запроса<br>- Нет SSL termination                  | Балансировка голосового трафика, подключения к Gateway |
| L7 (Application)| - URL-based<br>- Header-based<br>- Cookie-based<br>- Least Response Time | - Умная маршрутизация<br>- SSL termination<br>- Content awareness     | - Более высокая задержка<br>- Сложность настройки                      | Балансировка API запросов, WebSocket соединений       |
| Anycast       | - Shortest path (BGP)                         | - Автоматическая отказоустойчивость<br>- Минимальная задержка<br>- DDoS protection | - Сложность настройки BGP<br>- Требует собственные IP-блоки             | Голосовые серверы, критичные к задержке сервисы       |

---

### Ограничители производительности

- SSL Termination ([источник_16]) — основной ограничитель для L7 балансировщиков.  Это вызвано тем, что процесс расшифровки входящих SSL/TLS соединений требует значительных вычислительных ресурсов при установлении соединения и симметричного при передаче данных.


- Пропускная способность сети  ([источник_17]) — ограничение физических интерфейсов.  Это ограничение определяется скоростью сетевых карт, внутренней шиной коммутации между портами и возможностями обработки пакетов в секунду.


- Количество одновременных соединений — ограничение RAM и TCP-таблиц ядра.  Каждое соединение требует выделения 16-32 КБ памяти для буферов и структур данных, что создает существенную нагрузку на систему при высоких нагрузках.

- Процессорная мощность — обработка алгоритмов балансировки (Least Conn, RR). Вычислительная сложность варьируется от O(1) для простых алгоритмов до O(n) для более сложных методов распределения нагрузки



### Формулы резервирования

([источник_18])

- N+1 — для некритичных сервисов (веб, статика)  
- N×2 — для критичных сервисов и сервисов с непредсказуемыми пиками (стриминг, ивенты)  


### Расчёт количества балансировщиков

#### L7 балансировщики (SSL Termination)

- Пиковый RPS = **140,000**  [Ссылка на расчет](#расчет-нагрузки)
- Производительность 1 ноды = **50,000 RPS**  
- Необходимо = 140,000 / 50,000 = **≈3 ноды**  
- С резервированием (N+1) → **4 ноды на регион**


#### L4 балансировщики (Пропускная способность)

- Пиковый трафик = **533.3 Гбит/с**   [Ссылка на расчет](#расчет-нагрузки)
- Пропускная способность 1 ноды = **100 Гбит/с**  
- Необходимо = 533.3 / 100 = **≈6 нод**  
- С резервированием (N+1) → **7 нод на регион**



#### Голосовые серверы (N×2)

- Ожидаемая нагрузка = **630 потоков**  [Ссылка на расчет](#расчет-нагрузки)
- Производительность 1 ноды = **500 потоков**  
- Необходимо = 630 / 500 = **≈2 ноды**  
- С резервированием (N×2) → **4 ноды на регион**

---

### Механизмы автоматического регулирования

1) Health Checking — постоянный мониторинг состояния бэкенд-серверов через HTTP/HTTPS путем запросов на эндпоинты /health или TCP ping. Проверки выполняются каждые 5-10 секунд. При неуспешном ответе сервер исключается из пула балансировки. После восстановления возвращается в работу после нескольких успешных проверок подряд.

2) Circuit Breaker - автоматическое отключение неисправных серверов при превышении порога в 50% ошибок за 30 секунд. Все последующие запросы к такому серверу немедленно отклоняются без реальных попыток соединения, предотвращая каскадные сбои. 

3) Auto-scaling — динамическое добавление или удаление вычислительных нод на основе метрик нагрузки. Срабатывает при: загрузке CPU > 70%, достижении 80% от максимальной пропускной способности RPS, или задержке ответа > 200ms. 

4) Traffic Shifting — плавное перераспределение трафика между серверами при развертывании новых версий или замене оборудования. Реализуется через взвешенное распределение по схеме 10% → 50% → 100%, что позволяет постепенно наращивать нагрузку на новые ноды и отслеживать их стабильность перед полным переходом.

5) Load Shedding — стратегический сброс части трафика при экстремальных нагрузках для сохранения работоспособности критически важных функций. Система определяет менее важные запросы и возвращает им HTTP 503, сохраняя ресурсы для основных операций вроде голосовой связи и отправки сообщений.

## Логическая схема БД

### ER Диаграмма базы данных

```mermaid

erDiagram

users {
    int user_id PK
    string login
    string email
    string phone
    string password
    enum status
    timestamp created_at
    timestamp updated_at
}

profiles {
    int profile_id PK
    int user_id FK
    string nickname
    enum tag
    string avatar_path
    string description
    bool is_male
    date birthday
    bool is_online
    string about
    timestamp created_at
    timestamp updated_at
}

sessions {
    int session_id PK
    int user_id FK
    string token
    timestamp created_at
    timestamp expires_at
}

channels {
    int channel_id PK
    string chat_name
    string chat_desc
    bool is_group
    int member_count
    timestamp created_at
}

channel_members {
    int channel_id FK
    int profile_id FK
    enum role
    timestamp joined_at
}

subchannels {
    int subchannel_id PK
    int parent_channel_id FK
    string sub_name
    string description
    timestamp created_at
}

messages {
    int message_id PK
    int subchannel_id FK
    int author_profile_id FK
    string content
    int static_id FK
    timestamp created_at
    timestamp updated_at
}

message_reactions {
    int reaction_id PK
    int message_id FK
    int profile_id FK
    string emoji
    timestamp created_at
}

invitations {
    int invite_id PK
    int channel_id FK
    int created_by_profile_id FK
    string code
    timestamp created_at
    timestamp expires_at
}

notifications {
    int notification_id PK
    int user_id FK
    string content
    enum notification_type
    timestamp created_at
    timestamp read_at
}

blacklist {
    int block_id PK
    int user_id FK
    int blocked_user_id FK
    string reason
    timestamp created_at
}

static {
    int static_id PK
    enum type
    string path
    string mime_type
    int size_bytes
    timestamp created_at
}

%% Связи

users ||--|| profiles : "имеет профиль"
users ||--o{ sessions : "имеет сессии"
users ||--o{ notifications : "получает уведомления"
users ||--o{ blacklist : "может блокировать других"

profiles ||--o{ channel_members : "участвует в чатах"
profiles ||--o{ messages : "отправляет сообщения"
profiles ||--o{ invitations : "создает инвайты"
profiles ||--o{ message_reactions : "реагирует на сообщения"

channels ||--o{ subchannels : "имеет подразделы"
channels ||--o{ channel_members : "имеет участников"
channels ||--o{ invitations : "имеет приглашения"

subchannels ||--o{ messages : "включает сообщения"

messages ||--o{ message_reactions : "имеет реакции"
messages o{--|| static : "может ссылаться на медиа"




```
## Физическая схема БД



### Описание таблиц
| Таблица               | Назначение                    | Основные поля                                                                                                         | Ограничения / консистентность                                                                                                          | Связи                                                                | Средний размер записи  | QPS       | Пиковый QPS | Объём записи/с (средний) | Объём записи/с (пиковый) |
| --------------------- | ----------------------------- | --------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------- | ---------------------- | --------- | ----------- | ------------------------ | ------------------------ |
| **users**             | Аккаунты пользователей        | `user_id`, `login`, `email`, `phone`, `password`, `status`, `created_at`, `updated_at`                                | `login` и `email` UNIQUE, `status` ENUM (`active`, `banned`, `inactive`, `blocked`), `created_at` и `updated_at` — `CURRENT_TIMESTAMP` | `1→1` с `profiles`, `1→N` с `sessions`, `notifications`, `blacklist` | **132 B**              | **0.1**   | **0.2**     | **13 B/s**               | **26 B/s**               |
| **profiles**          | Профили пользователей         | `profile_id`, `user_id`, `nickname`, `tag`, `avatar_path`, `description`, `is_male`, `birthday`, `is_online`, `about` | `nickname` UNIQUE, `tag` ENUM (`default`, `vip`, `moderator`), `birthday <= now() - 14 лет`                                            | `N→1` с `users`, `1→N` с `messages`, `channel_members`               | **340 B**              | **0.1**   | **0.2**     | **34 B/s**               | **68 B/s**               |
| **sessions**          | Активные сессии пользователей | `session_id`, `user_id`, `token`, `created_at`, `expires_at`                                                          | `token` UNIQUE, `expires_at > now()`                                                                                                   | `N→1` с `users`                                                      | **80 B**               | **0.2**   | **0.5**     | **16 B/s**               | **40 B/s**               |
| **channels**          | Каналы/чаты                   | `channel_id`, `chat_name`, `chat_desc`, `is_group`, `member_count`, `created_at`                                      | `chat_name < 50`, `is_group` BOOLEAN, `member_count >= 0`                                                                              | `1→N` с `channel_members`, `subchannels`, `invitations`              | **128 B**              | **0.05**  | **0.1**     | **6 B/s**                | **12 B/s**               |
| **channel_members**   | Участники каналов             | `channel_id`, `profile_id`, `role`, `joined_at`                                                                       | `(channel_id, profile_id)` UNIQUE, `role` ENUM (`admin`, `moderator`, `member`)                                                        | `M↔N` между `profiles` и `channels`                                  | **24 B**               | **0.2**   | **0.4**     | **5 B/s**                | **10 B/s**               |
| **subchannels**       | Подканалы (подчаты)           | `subchannel_id`, `parent_channel_id`, `sub_name`, `description`, `created_at`                                         | `parent_channel_id` FK, `sub_name < 50`, `created_at <= now()`                                                                         | `N→1` с `channels`, `1→N` с `messages`                               | **96 B**               | **0.1**   | **0.2**     | **9.6 B/s**              | **19.2 B/s**             |
| **messages**          | Сообщения в подканалах        | `message_id`, `subchannel_id`, `author_profile_id`, `content`, `static_id`, `created_at`, `updated_at`                | `content < 1000`, `static_id` FK (nullable), `created_at <= now()`                                                                     | `N→1` с `subchannels`, `profiles`, `static`                          | **1 050 B**            | **9 346** | **28 038**  | **9.6 MB/s**             | **28.8 MB/s**            |
| **message_reactions** | Реакции к сообщениям          | `reaction_id`, `message_id`, `profile_id`, `emoji`, `created_at`                                                      | `(message_id, profile_id, emoji)` UNIQUE, `emoji < 10`                                                                                 | `N→1` с `messages`, `profiles`                                       | **48 B**               | **1 870** | **5 610**   | **90 KB/s**              | **270 KB/s**             |
| **invitations**       | Приглашения в каналы          | `invite_id`, `channel_id`, `created_by_profile_id`, `code`, `created_at`, `expires_at`                                | `code` UNIQUE, `expires_at > now()`                                                                                                    | `N→1` с `channels`, `profiles`                                       | **60 B**               | **1.2**   | **3.6**     | **72 B/s**               | **216 B/s**              |
| **notifications**     | Уведомления пользователей     | `notification_id`, `user_id`, `notification_type`, `content`, `created_at`, `read_at`                                 | `notification_type` ENUM (`system`, `message`, `invite`), `read_at >= created_at`                                                      | `N→1` с `users`                                                      | **220 B**              | **307**   | **921**     | **67 KB/s**              | **201 KB/s**             |
| **blacklist**         | Заблокированные пользователи  | `block_id`, `user_id`, `blocked_user_id`, `reason`, `created_at`                                                      | `(user_id, blocked_user_id)` UNIQUE, `reason < 100`                                                                                    | `N→1` с `users`                                                      | **110 B**              | **1.5**   | **4.5**     | **165 B/s**              | **495 B/s**              |
| **static**            | Статические ресурсы           | `static_id`, `type`, `path`, `mime_type`, `size_bytes`, `created_at`                                                  | `type` ENUM (`image`, `audio`, `video`, `document`, `other`), `path` UNIQUE                                                            | `1→N` с `messages`                                                   | **128 B (метаданные)** | **150**   | **450**     | **19 KB/s**              | **57 KB/s**              |


**Триггеры и консистентности**

1) created_at, updated_at - автоматическое обновление на текущее дату и время(например CURRENT_TIMESTAMP)

2) При удалении чатов - удалить сообщения, приглашения

3) При удалении пользователя - удалить профиля, сесиии, уведомления


### Распределение СУБД и ожидаемая нагрузка

| Таблица / Сущность    | СУБД           | Назначение                                       | Чтение QPS    | Запись QPS    | Обоснование выбора                                      |
| --------------------- | -------------- | ------------------------------------------------ | ------------- | ------------- | ------------------------------------------------------- |
| **users**             | **Cassandra**  | Регистрация, авторизация, блокировка             | Среднее       | Низкое        | Масштабируемая и шардированная СУБД для пользователей   |
| **profiles**          | **Cassandra**  | Расширенные профили пользователей                | Среднее       | Среднее       | Привязка к пользователю, быстрые выборки и обновления   |
| **sessions**          | **Tarantool**  | Активные сессии пользователей                    | Очень высокое | Высокое       | In-memory, мгновенный доступ                            |
| **blacklist**         | **Cassandra**  | Блокировка пользователей                         | Низкое        | Среднее       | Быстрый поиск по ключу, простая структура               |
| **notifications**     | **Tarantool**  | События и уведомления                            | Очень высокое | Среднее       | Быстрый доступ, in-memory база                          |
| **channels**          | **Cassandra**  | Список каналов                                   | Среднее       | Среднее       | Масштабируемость и независимость                        |
| **subchannels**       | **Cassandra**  | Подканалы для вложенных чатов                    | Среднее       | Среднее       | Быстрая запись/чтение, связи внутри Cassandra           |
| **channel_members**   | **Cassandra**  | Связь пользователей и каналов (роль, права)      | Среднее       | Среднее       | Быстрая фильтрация и права                              |
| **messages**          | **Cassandra**  | Основная масса сообщений                         | Очень высокое | Очень высокое | Высокая производительность на запись и масштабируемость |
| **message_reactions** | **Cassandra**  | Реакции/лайки на сообщения                       | Высокое       | Среднее       | Хорошо подходит для партиционированных данных           |
| **invitations**       | PostgreSQL     | Приглашения пользователей                        | Низкое        | Среднее       | Логическая согласованность                              |
| **static**            | PostgreSQL     | Метаданные файлов (type, path, analytics_fields) | Низкое        | Низкое        | Аналитические поля, простая структура                   |
| **media_storage**     | **Ceph**       | Объектное хранилище медиафайлов                  | Среднее       | Среднее       | Горизонтальное масштабирование                          |
| **analytics**         | **Prometheus** | Метрики, временные ряды                          | Высокое       | Низкое        | Для аналитики, не транзакционная БД                     |



### Индексы

| Таблица               | Индексы                              | Назначение                              |
| --------------------- | ------------------------------------ | --------------------------------------- |
| **blacklist**           | (user_id), (blocked_user_id)         | Быстрый поиск заблокированных           |
| **profiles**          | (user_id), (nickname)                   | Ускорение фильтрации              |
| **sessions**          | (session_token), (user_id), (token)           | Быстрый поиск сессии                    |
| **messages**          | (subchannel_id), (created_at)      | Последние сообщения                     |
| **message_reactions** | (message_id), (user_id)              | Быстрый подсчёт реакций                 |
| **channels**          | (channel_id), (name)                 | Навигация и поиск                       |
| **channel_members**   | (channel_id), (user_id), (role ENUM) | Права и роли                            |
| **notifications**     | (user_id), (created_at DESC)         | Быстрый доступ к последним уведомлениям |
| **static**            | (type), (path)                       | Быстрый поиск ресурсов                  |


### Репликации

| СУБД / Подсистема | Таблицы / Сущности                                                                         | Тип репликации             | Кол-во реплик | Обоснование и назначение                                       |
| ----------------- | ------------------------------------------------------------------------------------------ | -------------------------- | ------------- | -------------------------------------------------------------- |
| **PostgreSQL**    | `users`, `profiles`, `invitations`, `static`                                               | Master → Standby (async)   | 1–2           | Повышение отказоустойчивости и разгрузка чтения.               |
| **Cassandra**     | `blacklist`, `channels`, `subchannels`, `channel_members`, `messages`, `message_reactions` | Multi-master (eventual)    | 3             | Высокая доступность и равномерное распределение нагрузки.      |
| **Tarantool**     | `sessions`, `notifications`                                                                | Master–Master (in-memory)  | 2–3           | Минимальная задержка и мгновенное восстановление данных.       |
| **Ceph**          | `media_storage`, `static` (объектное хранилище)                                            | Erasure coding / CRUSH map | 3–5           | Хранение с дублированием и автоматическим восстановлением.     |
| **Prometheus**    | `analytics`                                                                                | Snapshot replication       | 1             | Репликация метрик для долгосрочного хранения и резервирования. |



### Шардирование

| Таблица               | Ключ шардирования | Алгоритм               | Обоснование / Принцип работы                                                                                                        |
| --------------------- | ----------------- | ---------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| **users**             | `user_id`         | `MOD(user_id, N)`      | Пользователи равномерно распределяются по шардам. Балансировка по числу пользователей, ключ уникален.                               |
| **profiles**          | `user_id`         | `MOD(user_id, N)`      | Привязка к пользователю, данные профиля логически связаны с users, обеспечивается локальность данных.                               |
| **sessions**          | `user_id`         | `HASH(user_id) % N`    | Сессии распределяются по пользователям. Быстрый доступ in-memory без пересечений.                                                   |
| **blacklist**         | `user_id`         | `HASH(user_id) % N`    | Запросы ориентированы на поиск блокировок по пользователю. Хэш-шардирование обеспечивает равномерное распределение и независимость. |
| **notifications**     | `user_id`         | `MOD(user_id, N)`      | Уведомления привязаны к пользователю. Простое деление по остатку для предсказуемости и равномерного распределения.                  |
| **channels**          | `channel_id`      | `HASH(channel_id) % N` | Каналы независимо масштабируются, данные распределяются по хэш-ключу для минимизации коллизий.                                      |
| **subchannels**       | `channel_id`      | `HASH(channel_id) % N` | Подканалы логически связаны с каналами, размещаются на тех же шардах для ускорения запросов.                                        |
| **channel_members**   | `channel_id`      | `HASH(channel_id) % N` | Члены канала хранятся совместно с самим каналом для ускорения выборок и агрегации.                                                  |
| **messages**          | `chat_id`         | `HASH(chat_id) % N`    | Сообщения группируются по чату. Распределение по хэшу обеспечивает низкую задержку и независимость каналов.                         |
| **message_reactions** | `message_id`      | `HASH(message_id) % N` | Реакции хранятся рядом с сообщениями, выборка по message_id. Логическая близость и равномерное распределение.                       |
| **static**            | `static_id`       | `MOD(static_id, N)`    | Метаданные распределяются по ID для горизонтального масштабирования.                                                                |
| **invitations**       | `user_id`         | `MOD(user_id, N)`      | Распределение по пользователю-отправителю, что снижает конкуренцию при массовых приглашениях.                                       |


### Резервное копирование

| СУБД           | Метод                    | Частота        | Хранилище |
| -------------- | ------------------------ | -------------- | --------- |
| **PostgreSQL** | `pg_dump + WAL shipping` | Ежедневно      | Ceph / S3 |
| **Cassandra**  | `nodetool snapshot`      | Ежедневно      | Ceph      |
| **Tarantool**  | `box.snapshot()`         | Каждые 6 часов | Ceph      |
| **Ceph**       | Встроенная репликация    | Постоянно      | CRUSH map |
| **Prometheus** | `snapshot export`        | Ежедневно      | Ceph      |


## Алгоритмы 

| **Алгоритм / Технология**                                                | **Применение в Discord**                                                                                 | **Решаемая проблема**                                                                         | **Краткое описание алгоритма**                                                                                                                                        |
| ------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1. Голосовая активность (VAD) + Шумоподавление (NS)**                  | Передача аудио только при речи пользователя с фильтрацией фонового шума (клавиатура, вентилятор, улица). | Избыточная передача аудио в моменты тишины, высокий трафик и шум в канале.                    | **VAD:** Анализ спектра и энергии сигнала для выявления речи. **NS:** Нейросетевая маска выделяет голос, подавляя несоответствующие шумы. Экономия до 60–80% трафика. |
| **2. Эхоподавление (AEC)**                                               | Устранение акустического эха, возникающего при использовании колонок и микрофона одновременно.           | Пользователь слышит свой голос с задержкой, мешая коммуникации.                               | Формируется модель сигнала, поступающего в динамик, и она вычитается из микрофонного сигнала в реальном времени.                                                      |
| **3. Адаптивное кодирование (Opus / AV1)**                               | Сжатие аудио и видео при звонках и стримах без потери восприятия качества.                               | Несжатое медиа перегружает канал, особенно при слабом интернете.                              | **Opus:** Меняет битрейт и параметры кодека «на лету» в зависимости от сети. **AV1:** Использует предсказание движения и контекста для эффективного видео-сжатия.     |
| **4. Перцептивная обработка звука (AGC + Эквалайзер)**                   | Автоматическая подстройка громкости и усиление разборчивости речи.                                       | Неравномерная громкость участников и потеря четкости речи.                                    | **AGC:** Автоматически выравнивает уровень громкости. **Эквалайзер:** Усиливает диапазон человеческой речи (1–4 кГц).                                                 |
| **5. Маршрутизация медиапотоков (SFU)**                                  | Масштабируемые групповые звонки и трансляции.                                                            | Прямая P2P-топология не выдерживает большое количество участников.                            | **SFU (Selective Forwarding Unit):** Клиенты отправляют медиапотоки серверу, который выборочно пересылает нужные потоки другим участникам без перекодирования.        |
| **6. Очереди и асинхронная доставка сообщений (Message Queue / PubSub)** | Чаты, уведомления, статус-ивенты, система сигналов.                                                      | Необходимость масштабной, мгновенной и отказоустойчивой доставки событий.                     | Используется **Pub/Sub**-модель (Redis, Kafka): издатель публикует событие, подписчики получают его асинхронно, без блокировки потоков.                               |
| **7. Дедупликация и обработка медиа (Media Deduplication)**              | Хранение и раздача файлов пользователей, аватаров, изображений и видео.                                  | Повторное хранение идентичных файлов создаёт избыточное использование дискового пространства. | Для каждого файла вычисляется **SHA-256**. При совпадении хеша создаётся ссылка на уже существующий объект без повторного сохранения.                                 |



## Список источников 

1) https://trends.rbc.ru/trends/industry/66fe701f9a7947ee414c2333
2) https://analyzify.com/statsup/discord 
3) https://helplama.com/discord-statistics/
4) https://www.tsviewer.com/index.php?page=teamspeak_statistics
5) https://habr.com/ru/articles/495336/
6) https://www.cloudwards.net/discord-statistics
7) https://www.businessofapps.com/data/discord-statistics
8) https://discord.com/blog/how-discord-stores-trillions-of-messages
9) https://www.semrush.com/website/discord.com/overview/
10) https://www.similarweb.com/website/discord.com/#geography
11) https://www.techinsider.ru/gadgets/254242-karta-vsekh-ustroystv-s-vykhodom-v-internet-2016/
12) https://www.submarinecablemap.com
13) https://www.internetexchangemap.com/#/building/1831
14)  https://store.steampowered.com/charts/
15) https://www.bankmycell.com/blog/number-of-discord-users/#:~:text=Growth%20of%20Daily%20Active%20Users,users%20from%202023%20to%202025
16) https://www.geeksforgeeks.org/computer-networks/ssl-termination/
17) https://www.intel.com/content/www/us/en/products/sku/128970/intel-ethernet-connection-c827im1/specifications.html
18) https://www.coresite.com/blog/data-center-redundancy-n-1-vs-2n-1
19) https://anycast.com/what-it-leaders-need-to-know-about-bgp-anycast/
20) https://medium.com/@sohail_saifi/the-genius-architecture-behind-discords-voice-chat-that-zoom-could-learn-from-1da9a8c5b08f


[источник_1]: https://trends.rbc.ru/trends/industry/66fe701f9a7947ee414c2333 "Топ-7 аналогов Discord, которые работают в России"

[источник_2]: https://analyzify.com/statsup/discord "Discord Statistics"

[источник_3]: https://helplama.com/discord-statistics/ "Discord Revenue and Usage Statistics 2025"

[источник_4]: https://www.tsviewer.com/index.php?page=teamspeak_statistics "TeamSpeak 3 Statistics"

[источник_5]: https://habr.com/ru/articles/495336/ "Discord как корпоративный мессенджер и не только"

[источник_6]: https://www.cloudwards.net/discord-statistics "20 Discord Statistics, Facts and Trends for 2025"

[источник_7]: https://www.businessofapps.com/data/discord-statistics "Discord Revenue and Usage Statistics (2025)"

[источник_8]:  https://discord.com/blog/how-discord-stores-trillions-of-messages "How Discord Stores Trillions of Messages"

[источник_9]: https://www.semrush.com/website/discord.com/overview/ "discord.com August 2025 Traffic Stats"

[источник_10]:  https://www.similarweb.com/website/discord.com/#geography

[источник_11]:  https://www.techinsider.ru/gadgets/254242-karta-vsekh-ustroystv-s-vykhodom-v-internet-2016/

[Submarine Cable Map]: https://www.submarinecablemap.com

[IXP]: https://www.internetexchangemap.com/#/building/1831

[источник_14]: https://store.steampowered.com/charts/

[источник_15]: https://www.bankmycell.com/blog/number-of-discord-users/#:~:text=Growth%20of%20Daily%20Active%20Users,users%20from%202023%20to%202025.

[источник_16]: https://www.geeksforgeeks.org/computer-networks/ssl-termination/

[источник_17]: https://www.intel.com/content/www/us/en/products/sku/128970/intel-ethernet-connection-c827im1/specifications.html

[источник_18]: https://www.coresite.com/blog/data-center-redundancy-n-1-vs-2n-1

[источник_19]: https://anycast.com/what-it-leaders-need-to-know-about-bgp-anycast/

[источник_20]: https://medium.com/@sohail_saifi/the-genius-architecture-behind-discords-voice-chat-that-zoom-could-learn-from-1da9a8c5b08f